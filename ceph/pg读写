ä»€ä¹ˆæ˜¯pg
pgçš„æ•°æ®è¯»å†™æµç¨‹
ä¸€ä¸ªpgçš„å¤šå‰¯æœ¬ä¸€è‡´æ€§é—®é¢˜
pgå¦‚ä½•åœ¨osdé—´è¿ç§»ï¼Œè¿›è€Œå®ç°æ•°æ®æ¢å¤å’Œæ•°æ®å¹³è¡¡

=======================================================================================================================================================
æ¦‚å¿µï¼š
peering:
å½“é›†ç¾¤å‘ç”Ÿå˜åŠ¨ï¼ˆå¦‚æ–°å¢/ä¸‹çº¿ OSDã€é‡å¯ã€ç½‘ç»œåˆ†åŒºç­‰ï¼‰ï¼ŒPG ä¸­çš„æ•°æ®å‰¯æœ¬å¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒ OSD ä¸Šã€‚è¿™æ—¶å€™ Ceph éœ€è¦é‡æ–°åè°ƒè¿™äº›å‰¯æœ¬ï¼Œ
ä»¥æ‰¾å‡ºå“ªä¸€ä¸ªå‰¯æœ¬æ˜¯æœ€æ–°çš„ã€å“ªäº›å‰¯æœ¬éœ€è¦åŒæ­¥ï¼Œè¿™ä¸€è¿‡ç¨‹å°±å« Peeringï¼ˆå¯¹ç­‰åå•†ï¼‰
ä»€ä¹ˆæ˜¯ PG Peeringï¼Ÿ
Peering æ˜¯ä¸€ä¸ª åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®è¿‡ç¨‹ï¼Œç›®çš„æ˜¯è®©åŒä¸€ä¸ª PG çš„å¤šä¸ªå‰¯æœ¬ï¼ˆOSD ä¸Šçš„ï¼‰å½¼æ­¤â€œå¯¹é½â€ï¼Œè¾¾æˆä¸€è‡´çš„è§†å›¾ã€‚

åœ¨ peering è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªå‚ä¸å‰¯æœ¬ä¼šæŠ¥å‘Šè‡ªå·±æ‰€æ‹¥æœ‰çš„ PG çš„æœ€æ–°çŠ¶æ€ï¼ˆæ—¥å¿—ã€ç‰ˆæœ¬å·ã€å¯¹è±¡åˆ—è¡¨ç­‰ï¼‰ï¼Œä¸» OSDï¼ˆacting primaryï¼‰åŸºäºè¿™äº›ä¿¡æ¯å†³å®šï¼š

å“ªäº›å¯¹è±¡æ˜¯æœ€æ–°çš„ï¼›

å“ªäº›å‰¯æœ¬éœ€è¦è¿›è¡Œæ¢å¤ï¼ˆrecoveryï¼‰æˆ–é‡åŒæ­¥ï¼ˆbackfillï¼‰ï¼›

æ˜¯å¦å¯ä»¥è¿›å…¥ active+clean çŠ¶æ€ï¼ˆå³å¯å¯¹å¤–æä¾›æœåŠ¡ï¼‰ã€‚

ğŸ”„ ä¸ºä»€ä¹ˆéœ€è¦ Peeringï¼Ÿ
å› ä¸º Ceph æ˜¯ä¸€ä¸ªé«˜åº¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒPG çš„å‰¯æœ¬åˆ†å¸ƒåœ¨å¤šä¸ª OSD ä¸Šï¼Œè€Œè¿™äº›å‰¯æœ¬ä¹‹é—´å¯èƒ½å‡ºç°ä»¥ä¸‹æƒ…å†µï¼š

æŸä¸ª OSD å´©æºƒåˆé‡å¯ï¼Œæ•°æ®æ˜¯å¦ä¸¢å¤±ï¼Ÿ

OSDMap å˜æ›´ï¼ŒPG è¢«è¿ç§»åˆ°äº†å…¶ä»– OSDï¼›

æœ‰å†™å…¥æ“ä½œåœ¨æŸäº›å‰¯æœ¬æˆåŠŸï¼Œå…¶ä»–å‰¯æœ¬å¤±è´¥ï¼›

ç½‘ç»œåˆ†åŒºæ—¶ï¼ŒPG çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´ã€‚

ä¸ºäº†ä¿è¯è¿™äº›æƒ…å†µä¹‹åï¼Œé›†ç¾¤ä»ç„¶æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼Œå¿…é¡»è¿›è¡Œä¸€æ¬¡ peering æ¥ åå•†â€œå“ªä¸ªæ˜¯æ­£ç¡®çš„ PG çŠ¶æ€â€ã€‚

ğŸ“Œ Peering è§¦å‘çš„å…¸å‹åœºæ™¯ï¼š
OSD å¯åŠ¨æˆ–é‡å¯ï¼›

OSD å´©æºƒæˆ–ä¸‹çº¿ï¼›

é›†ç¾¤æ–°å¢æˆ–ç§»é™¤ OSDï¼›

OSDMap æ›´æ–°ï¼ˆæ¯”å¦‚ crush map å˜åŒ–ï¼‰ï¼›

é‡æ–°å¹³è¡¡ï¼ˆrebalanceï¼‰å‘ç”Ÿï¼›

æ•´ä¸ªé›†ç¾¤é‡å¯ã€‚
ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹
osd map:
OSD Map æ˜¯ä¸€ä¸ªç”± Monitor ç»´æŠ¤çš„ã€æè¿°é›†ç¾¤æ‹“æ‰‘å’Œ OSD çŠ¶æ€çš„æ˜ å°„è¡¨ï¼ŒåŒ…å«äº†æ‰€æœ‰ OSD çš„å¥åº·çŠ¶æ€ã€PG åˆ° OSD çš„æ˜ å°„è§„åˆ™ç­‰å…³é”®ä¿¡æ¯ã€‚

âœ… OSD Map åŒ…å«å“ªäº›ä¿¡æ¯ï¼Ÿ
ä¿¡æ¯é¡¹	è¯´æ˜
æ‰€æœ‰ OSD çš„ ID å’ŒçŠ¶æ€	åŒ…æ‹¬æ¯ä¸ª OSD æ˜¯å¦ up/downï¼Œin/out
CRUSH æ˜ å°„	ç”¨äºæ•°æ®åˆ†å¸ƒçš„è§„åˆ™ï¼ˆåŒ…æ‹¬æƒé‡ç­‰ï¼‰
PG åˆ° OSD çš„æ˜ å°„	æ¯ä¸ª PG åº”è¯¥ç”±å“ªäº› OSD å­˜å‚¨å‰¯æœ¬
ç‰ˆæœ¬å·ï¼ˆepochï¼‰	æ¯æ¬¡å˜åŠ¨éƒ½åŠ ä¸€ï¼Œç¡®ä¿æœ‰åºæ›´æ–°
Pool ä¿¡æ¯	åŒ…æ‹¬ Pool æ•°é‡ã€PG æ•°é‡ã€å‰¯æœ¬æ•°ç­‰
å†å²äº‹ä»¶ï¼ˆå¦‚ OSD æ·»åŠ ï¼‰	å¸®åŠ©æ¢å¤æ—¶å›æº¯çŠ¶æ€å˜åŒ–

âœ… å®ƒæ˜¯å¹²å˜›ç”¨çš„ï¼Ÿ
å®¢æˆ·ç«¯åŸºäº OSD Map + CRUSH ç®—æ³•å¯ä»¥å®šä½å¯¹è±¡åœ¨å“ªä¸ª OSD ä¸Šï¼ˆæ— é¡»ä¸­å¿ƒè·¯ç”±ï¼‰ï¼›

OSD ä¹‹é—´é€šè¿‡å®ƒåè°ƒ PG æ‰€å±ã€å‰¯æœ¬å‰¯æœ¬ä¸€è‡´æ€§ç­‰ï¼›

ç”¨äº PG peeringã€æ•°æ®æ¢å¤ã€è¿ç§»ç­‰é‡è¦æµç¨‹ï¼›

ä¿è¯é›†ç¾¤ä¸€è‡´æ€§å’Œæ•…éšœæ¢å¤çš„å…³é”®ã€‚

âœ… ä¸¾ä¸ªç®€å•ä¾‹å­ï¼š
å‡è®¾ä½ æœ‰ï¼š

4 ä¸ª OSDï¼šID ä¸º 0~3ï¼›

æœ‰ä¸€ä¸ª Pool è®¾ç½®ä¸º 64 ä¸ª PGï¼Œæ¯ä¸ª PG ä¿æŒ 2 ä¸ªå‰¯æœ¬ï¼›

OSD Map ä¼šå‘Šè¯‰ä½ ï¼š

OSD.2 å½“å‰æ˜¯ down çŠ¶æ€ï¼›

PG 3 çš„å‰¯æœ¬åœ¨ OSD.0 å’Œ OSD.2ï¼›

PG 3 éœ€è¦æ¢å¤ä¸€ä¸ªå‰¯æœ¬åˆ° OSD.1ï¼Œå› ä¸º OSD.2 downï¼›

OSD.1 ç›®å‰ inï¼Œä¸”æœ‰è¶³å¤Ÿç©ºé—´ï¼›

å®¢æˆ·ç«¯æŸ¥è¯¢å¯¹è±¡ hash ä¸º PG 3ï¼Œæ ¹æ® OSD Map å¾—çŸ¥åº”è”ç³» OSD.0 è¯»å–ã€‚

ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹
ä¸€ä¸ªpgä¸­æœ‰å“ªäº›ä¸åŒçš„å¯¹è±¡ï¼š
head å¯¹è±¡ï¼šå½“å‰æœ€æ–°ç‰ˆæœ¬çš„æ•°æ®å¯¹è±¡ï¼›

clone å¯¹è±¡ï¼šè¡¨ç¤ºæŸä¸ªå¿«ç…§æ—¶åˆ»çš„å†å²æ•°æ®å‰¯æœ¬ï¼ˆå®é™…å­˜å‚¨äº†å½“æ—¶çš„å¯¹è±¡æ•°æ®ï¼‰ï¼›

snapdir å¯¹è±¡ï¼šç”¨äºç®¡ç†ä¸€ä¸ªå¯¹è±¡çš„å¿«ç…§ä¿¡æ¯å…ƒæ•°æ®ï¼ˆä¸åŒ…å«å®é™…æ•°æ®ï¼‰ã€‚

ğŸ”„ å…·ä½“åˆ†å·¥ï¼š
ç±»å‹	å†…å®¹	ä½œç”¨
head	å½“å‰å¯¹è±¡çš„æœ€æ–°æ•°æ®	æ™®é€šè¯»å†™æ“ä½œé’ˆå¯¹çš„å¯¹è±¡
clone	æ¯ä¸ªå¿«ç…§æ—¶åˆ»çš„å¯¹è±¡å‰¯æœ¬	ä¿ç•™å¯¹è±¡çš„å†å²æ•°æ®ï¼ˆå¯ä»¥é€šè¿‡å¿«ç…§è®¿é—®ï¼‰
snapdir	å¿«ç…§åˆ—è¡¨ + clone æ˜ å°„ä¿¡æ¯	è®°å½•æœ‰å“ªäº›å¿«ç…§ã€æ¯ä¸ªå¿«ç…§æŒ‡å‘å“ªä¸ª clone

ğŸ” ä¸¾ä¸ªä¾‹å­ï¼š
ä½ å¯¹å¯¹è±¡ foo æ‰“äº†ä¸¤ä¸ªå¿«ç…§ snap1 å’Œ snap2ï¼Œç„¶åç»§ç»­ä¿®æ”¹å¯¹è±¡å†…å®¹ã€‚

é‚£ä¹ˆ Ceph ä¼šï¼š

æŠŠ snap1 å’Œ snap2 æ—¶åˆ»çš„å¯¹è±¡å†…å®¹åˆ†åˆ«æ‹·è´æˆä¸¤ä¸ª cloneï¼ˆå¦‚ foo@snap1, foo@snap2ï¼‰ï¼›

æŠŠè¿™ä¸¤ä¸ª clone çš„å…ƒä¿¡æ¯ï¼ˆå®ƒä»¬å±äºå“ªä¸ªå¿«ç…§ï¼Œæ—¶é—´æˆ³ç­‰ï¼‰å†™å…¥ foo~snapdir å¯¹è±¡ä¸­ï¼›

ç»§ç»­çš„å†™æ“ä½œåªå½±å“ fooï¼ˆhead å¯¹è±¡ï¼‰æœ¬èº«ï¼Œä¸ä¼šå½±å“ cloneã€‚

âœ… ä¸ºä»€ä¹ˆè¦åˆ†å¼€å­˜ï¼Ÿ
clone å­˜æ•°æ®ï¼šå› ä¸ºå¿«ç…§è¦æ”¯æŒè¯»å†å²æ•°æ®ï¼Œå¿…é¡»ä¿å­˜å½“æ—¶çš„æ•°æ®ç‰ˆæœ¬ï¼›

snapdir å­˜å…ƒæ•°æ®ï¼šé›†ä¸­ç®¡ç† clone çš„æ˜ å°„å…³ç³»ã€å¿«ç…§ IDã€æ—¶é—´æˆ³ç­‰ï¼Œæ–¹ä¾¿å¿«ç…§éå†å’Œæ¢å¤ã€‚

ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹
omap ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ
OMAP ä¸»è¦ç”¨äºå­˜å‚¨å¯¹è±¡çš„å…ƒæ•°æ®ï¼Œå¸¸è§çš„ç”¨é€”æœ‰ï¼š

ç”¨é€”	ç¤ºä¾‹è¯´æ˜
RADOSGW å…ƒæ•°æ®å­˜å‚¨	æ¯”å¦‚ S3 çš„ object tagã€ACLã€versioning ä¿¡æ¯ç­‰
RBD é•œåƒå…ƒæ•°æ®	RBD é•œåƒå¿«ç…§ã€å±‚ç»“æ„ã€æ˜ å°„å…³ç³»
CephFS çš„ inode ä¿¡æ¯	å­˜å‚¨ inode å¯¹è±¡çš„å±æ€§ï¼ˆå¦‚æƒé™ã€æ—¶é—´æˆ³ç­‰ï¼‰
Bluestore è‡ªèº«å†…éƒ¨ç®¡ç†ç”¨é€”	è®°å½•å¯¹è±¡çŠ¶æ€ã€å›æ»šä¿¡æ¯ç­‰

ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹
pg è¯»å†™æµç¨‹
1 ï¼‰OSD æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„è¯»å†™è¯·æ±‚ï¼Œå°†å…¶å°è£…ä¸ºä¸€ä¸ª op å¹¶åŸºäºå…¶æºå¸¦çš„ PGID è½¬ å‘è‡³ç›¸åº”çš„ PGO 

2 ï¼‰PG æ”¶åˆ° op åï¼Œå®Œæˆä¸€ç³»åˆ—æ£€æŸ¥ï¼Œæ‰€æœ‰æ¡ä»¶å‡æ»¡è¶³åï¼Œå¼€å§‹çœŸæ­£æ‰§è¡Œ opã€‚

3 ï¼‰å¦‚æœ op åªåŒ…å«è¯»æ“ä½œï¼Œé‚£ä¹ˆç›´æ¥æ‰§è¡ŒåŒæ­¥è¯»ï¼ˆå¯¹åº”å¤šå‰¯æœ¬ï¼‰æˆ–è€…å¼‚æ­¥è¯»ï¼ˆå¯¹åº”çº  åˆ ç ï¼‰ï¼Œ ç­‰å¾…è¯»æ“ä½œå®Œæˆåå‘å®¢æˆ·ç«¯åº”ç­”ã€‚ 

4 ï¼‰å¦‚æœ op åŒ…å«å†™æ“ä½œï¼Œé¦–å…ˆç”± Primary åŸºäº op ç”Ÿæˆä¸€ä¸ªé’ˆå¯¹åŸå§‹å¯¹è±¡æ“ä½œçš„äº‹åŠ¡
åŠç›¸å…³æ—¥å¿—ï¼Œç„¶åå°†å…¶æäº¤è‡³ PGBackend, ç”± PGBackend æŒ‰ç…§å¤‡ä»½ç­–ç•¥è½¬åŒ–ä¸ºæ¯ä¸ª PG
å®ä¾‹ï¼ˆåŒ…å« Primary å’Œæ‰€æœ‰ Replicaï¼‰çœŸæ­£éœ€è¦æ‰§è¡Œçš„æœ¬åœ°äº‹åŠ¡å¹¶è¿›è¡Œåˆ†å‘ï¼Œå½“ Primary æ”¶åˆ°æ‰€æœ‰å‰¯æœ¬çš„å†™å…¥å®Œæˆåº”ç­”ä¹‹åï¼Œ
å¯¹åº”çš„ op æ‰§è¡Œå®Œæˆï¼Œæ­¤æ—¶ç”± Primary å‘å®¢æˆ·ç«¯å›åº” å†™å…¥å®Œæˆ

ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹
ä¸€äº›æœ¯è¯­ï¼š
Acting Set æ˜¯ä»€ä¹ˆï¼Ÿ
å½“ä¸€ä¸ª PGï¼ˆæ¯”å¦‚ pg 1.23ï¼‰è¢«æ˜ å°„åˆ°è‹¥å¹²ä¸ª OSD ä¸Šæ—¶ï¼ˆæ ¹æ® CRUSH è§„åˆ™å’Œ OSDMapï¼‰ï¼ŒCeph ä¼šé€‰å‡ºä¸€ç»„ OSD æ¥â€œå®é™…æ‰§è¡Œâ€è¯¥ PG çš„å‰¯æœ¬ç®¡ç†å’Œ I/O æ“ä½œï¼Œè¿™ç»„ OSD å°±æ˜¯ Acting Setã€‚

å®ƒåŒ…å«ï¼š
Primary OSDï¼ˆä¸»å‰¯æœ¬ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼‰
Replica OSD(s)ï¼ˆä»å‰¯æœ¬ï¼ŒåŒæ­¥ä¸»å‰¯æœ¬çš„å†™å…¥ï¼‰

ä¸ºä»€ä¹ˆéœ€è¦ up setï¼Ÿ
å› ä¸º up set æ˜¯ç”± CRUSH ç®—æ³• + OSD map å†³å®šçš„ï¼Œæ˜¯ PG æ‰€å±çš„â€œæ³•å®šä½ç½®â€ï¼š

å®ƒå‘Šè¯‰ç³»ç»Ÿ åœ¨æ²¡æœ‰æ•…éšœçš„å‰æä¸‹ï¼ŒPG åº”è¯¥åœ¨å“ªäº› OSD ä¸Šã€‚

å®ƒæŒ‡å¯¼ peering è¿‡ç¨‹ä¸­ï¼Œåº”è¯¥å»è”ç³»å“ªäº› OSD è·å–çŠ¶æ€ã€‚

å®ƒç”¨äºåˆ¤æ–­å“ªäº› OSD æ˜¯ â€œå¤±è”çš„æˆå‘˜â€ï¼Œéœ€è¦æ¢å¤ã€æ›¿æ¢æˆ–ä¿®å¤ã€‚

ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ acting setï¼Ÿ
å› ä¸ºçœŸå®ä¸–ç•Œä¸­ OSD æ€»ä¼šæœ‰å®•æœºæˆ–ä¸¢å¤±çš„å¯èƒ½ï¼Œä¸èƒ½ç›²ç›®ä¿¡ä»» up setã€‚

æ‰€ä»¥éœ€è¦ä¸€ä¸ª**â€œå®é™…æ­£åœ¨å·¥ä½œâ€çš„é›†åˆ**ï¼Œå³ acting setï¼š

æ˜¯ peering ä¹‹åé€‰å‡ºçš„ã€å½“å‰å¯ç”¨ä¸”å‰¯æœ¬ä¸€è‡´çš„ OSD é›†åˆï¼›

æ‰€æœ‰å¯¹ PG çš„ è¯»å†™æ“ä½œéƒ½åªä¼šåœ¨ acting set ä¸­æ‰§è¡Œï¼›

å¦‚æœ acting set æˆå‘˜å°‘äºå‰¯æœ¬æ•°ï¼ˆå¦‚ä» 3 ä¸ªé™åˆ° 2 ä¸ªï¼‰ï¼ŒPG å°±æ˜¯ degraded çŠ¶æ€ã€‚

PG Peering é˜¶æ®µã€‘ï¼šå»ºç«‹å…±è¯†ï¼Œå†³å®šå½“å‰æœ‰å“ªäº›æ•°æ®å‰¯æœ¬æ˜¯å¯ä¿¡çš„ï¼ˆå³ acting setï¼‰
å½“ä¸€ä¸ª PG æ‰€å±çš„ OSD é‡å¯ã€crashã€ç½‘ç»œå˜åŠ¨æˆ– OSD map å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒPG ä¼šè¿›å…¥ peering çŠ¶æ€ã€‚

æ­¤æ—¶ï¼Œç³»ç»Ÿä¼šå°è¯•è”ç³» up set ä¸­çš„ OSDï¼Œè¯¢é—®å®ƒä»¬æœ‰æ²¡æœ‰è¿™ä¸ª PG çš„æœ€æ–°æ•°æ®ã€‚

æ¯ä¸ª OSD ä¼šæŠ¥å‘Šè‡ªå·±æ‰€æŒæœ‰çš„ PG çŠ¶æ€ï¼ˆåŒ…æ‹¬ epochã€ç‰ˆæœ¬å·ç­‰ï¼‰ã€‚

Ceph çš„ OSD ä¼šæ ¹æ®å„å‰¯æœ¬çš„æ—¥å¿—ã€å¯¹è±¡ç‰ˆæœ¬ï¼Œåå•†å‡ºä¸€ç»„å®Œæ•´ä¸€è‡´çš„ PG å‰¯æœ¬ â€”â€” è¿™å°±æ˜¯æ–°çš„ acting setã€‚

æ€»ç»“ä¸€å¥è¯ï¼Œ upset å¯¹peering é€‰ä¸¾æœ‰æ•ˆosd æœ‰æŒ‡å¯¼ä½œç”¨ï¼Œå‘Šè¯‰ç³»ç»Ÿä¸­å“ªäº›osdæ˜¯ç†è®ºä¸Šå¯ç”¨çš„ï¼Œåç»­peering + recover ç”Ÿæˆ acting set ä¿æŒä¸€è‡´ã€‚

ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹peering + recoverã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Š
âœ… è¯´æ˜ï¼š
up set æä¾›â€œç†è®ºä¸Šåº”è¯¥æœ‰å“ªäº›èŠ‚ç‚¹å‚ä¸ peeringâ€ã€‚
acting set æ˜¯ peering çš„ç»“æœï¼Œä»£è¡¨â€œå®é™…ä¸Šå“ªäº›èŠ‚ç‚¹æŒæœ‰å‰¯æœ¬â€ã€‚
2ï¸âƒ£ ã€Recovery é˜¶æ®µã€‘ï¼šä¿®å¤ acting set å’Œ up set çš„å·®å¼‚
å‡å¦‚ peering å‘ç°ï¼š

up set = [1, 3, 4]ï¼ˆç†åº”çš„æ•°æ®ä½ç½®ï¼‰

acting set = [1, 3]ï¼ˆå®é™…æ‹¥æœ‰æ•°æ®ï¼‰

OSD.4 æ˜¯ç©ºçš„ã€å¥åº·çš„ï¼Œé‚£ä¹ˆï¼š

ç³»ç»Ÿä¼šï¼š

ä» OSD.1 æˆ– OSD.3 æŠŠæ•°æ® å¤åˆ¶åˆ° OSD.4ï¼›

ç­‰å¤åˆ¶å®Œæˆåï¼Œacting set å˜ä¸º [1, 3, 4]ï¼›

è¿™æ · acting set å°±ä¸ up set å¯¹é½äº†ï¼›

æœ€ç»ˆè¾¾åˆ° clean çŠ¶æ€ï¼ŒPG æ¢å¤å¥åº·ã€‚


        OSD map å˜æ›´ / OSD é‡å¯ / PG ä¸å¥åº·
                         â†“
                  ğŸ”„ PG è¿›å…¥ Peering çŠ¶æ€
                         â†“
        ä¸ up set ä¸­çš„ OSD åè®®åå•† PG çŠ¶æ€ã€ç‰ˆæœ¬
                         â†“
        â¤ å¦‚æœå¯ä»¥ç¡®å®šå®Œæ•´ä¸€è‡´çš„ PG å‰¯æœ¬
                         â†“
        âœ… Peering æˆåŠŸ â†’ ç”Ÿæˆæ–°çš„ acting set
                         â†“
        ğŸ“¦ Recovery å¼€å§‹ï¼šè¡¥é½ acting set åˆ° up set

ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹peeringæ˜¯å¦‚ä½•åˆ¤æ–­å“ªä¸ªå‰¯æœ¬æ˜¯å¯ç”¨çš„ç”¨äºåç»­recover
æ‰¾å‡ºä¸€ç»„å‰¯æœ¬ï¼Œå®ƒä»¬ä¹‹é—´åœ¨å¯¹è±¡ã€æ—¥å¿—ç­‰æ–¹é¢çš„ä¸€è‡´æ€§è¶³å¤Ÿï¼Œèƒ½å¤Ÿå®Œå…¨é‡æ„å‡º PG çš„æ•°æ®çŠ¶æ€ã€‚è¿™ä¸€ç»„å‰¯æœ¬å°±æ˜¯å¯æ¢å¤çš„â€œæºâ€ï¼Œåç»­æ¢å¤è¿‡ç¨‹ä¼šåŸºäºè¿™ç»„å‰¯æœ¬è¿›è¡Œã€‚

ğŸ” æ­¥éª¤è¯¦è§£ï¼š
è§¦å‘ peering çš„æ—¶æœºï¼š

OSD crash/rebootï¼›

ç½‘ç»œæ–­è”ï¼›

OSDMap æ›´æ–°ï¼ˆæ–°å¢/å‰”é™¤ OSDï¼‰ï¼›

ä¸»åŠ¨è§¦å‘ï¼Œæ¯”å¦‚ admin æ“ä½œã€‚

æ‰€æœ‰ up set ä¸­çš„ OSD ä¸ŠæŠ¥ PG çŠ¶æ€ï¼š
æ¯ä¸ª OSD ä¸ŠæŠ¥å…¶æŒæœ‰çš„ PG çš„ï¼š

last_update: æœ€åä¸€æ¬¡æ›´æ–°çš„ç‰ˆæœ¬ï¼›

last_complete: æœ€åä¸€æ¬¡â€œå®Œæ•´â€çŠ¶æ€çš„ç‰ˆæœ¬ï¼›

log: æœ€è¿‘çš„æ“ä½œæ—¥å¿—ï¼ˆå†™ã€åˆ é™¤ç­‰ï¼‰ï¼›

missing set: ç¼ºå¤±çš„å¯¹è±¡ç‰ˆæœ¬ï¼›

object info: å¯¹è±¡çš„å…ƒä¿¡æ¯æ‘˜è¦ï¼›

epoch: è¿™ä¸ªçŠ¶æ€åœ¨å“ªä¸ª OSDMap æ—¶æœ‰æ•ˆã€‚

ä¸» OSDï¼ˆusually primaryï¼‰åˆ†æå‰¯æœ¬çŠ¶æ€ï¼š
å®ƒä¼šæ ¹æ®ï¼š

å“ªäº› OSD æœ‰æœ€è¿‘çš„æ›´æ–°ï¼ˆlast_update æœ€å¤§ï¼‰ï¼›

å“ªäº› OSD æœ‰å®Œæ•´çš„å†å²è®°å½•å’Œæ•°æ®ï¼ˆlast_complete æœ€ä¸€è‡´ï¼‰ï¼›

å“ªäº›å‰¯æœ¬æ—¥å¿—å†…å®¹ä¸€è‡´ï¼›

å“ªäº›å‰¯æœ¬çš„ missing set æœ€å°‘ï¼›
æ¥åˆ¤æ–­å‡ºå“ªä¸€ç»„å‰¯æœ¬èƒ½ç»„åˆå‡ºä¸€ä¸ªå¯æ¢å¤çš„æ•°æ®å¿«ç…§ã€‚

é€‰å‡º acting setï¼š
ä¸» OSD æ ¹æ®ä¸Šé¢åˆ†æï¼Œé€‰æ‹©ä¸€ç»„â€œè¶³å¤Ÿä¸€è‡´ä¸”å®Œæ•´â€çš„ OSD ä½œä¸º acting setï¼Œå³ï¼š

æ¥ä¸‹æ¥è¯»å†™ç”±è¿™ç»„ OSD æ‰¿æ‹…ï¼›

æ¢å¤ï¼ˆrecoveryï¼‰æ•°æ®ä¹Ÿå°†ä»è¿™ç»„ OSD æ‹‰å–å‰¯æœ¬åŒæ­¥åˆ°ç¼ºå¤± OSDã€‚

âœ… ä¸¾ä¸ªç®€å•ä¾‹å­ï¼š
å‡è®¾ PG 101 æœ‰ up set = [osd.1, osd.2, osd.3]ï¼Œå…¶ä¸­ï¼š

OSD	last_update	last_complete	missing
osd.1	v.100	v.100	âˆ…
osd.2	v.100	v.100	âˆ…
osd.3	v.98	v.98	[v.99, v.100]

osd.1 å’Œ osd.2 æŒæœ‰å®Œæ•´çš„ã€æœ€æ–°çš„ä¸€è‡´å‰¯æœ¬ï¼›

osd.3 ç¼ºå°‘ä¸¤æ¬¡å†™æ“ä½œã€‚

â†’ æ‰€ä»¥ osd.1 å’Œ osd.2 ä¼šè¢«é€‰å…¥ acting setï¼Œosd.3 ä¼šä½œä¸ºæ¢å¤ç›®æ ‡è¢«é‡æ–°åŒæ­¥ã€‚

ğŸš¨ ä¸ºä»€ä¹ˆä¸èƒ½åªçœ‹ç‰ˆæœ¬å·ï¼Ÿ
å› ä¸ºæœ‰æ—¶ç‰ˆæœ¬å·è™½ç„¶ç›¸åŒï¼Œä½†ï¼š

å®é™…å†…å®¹å¯èƒ½è¢«æŸåï¼ˆbitrotï¼‰ï¼›

æ—¥å¿—ä¸ä¸€è‡´ï¼ˆæ¯”å¦‚æœ‰çš„æ—¥å¿—æœªè½ç›˜ï¼‰ï¼›

OSD ä¹‹é—´ epoch ä¸ä¸€è‡´ï¼ˆå¯¹åº”ä¸åŒçš„ OSDMap ä¸Šä¸‹æ–‡ï¼‰ï¼›

æ‰€ä»¥å¿…é¡»ç»¼åˆå¤šç§å› ç´ åˆ¤æ–­ï¼Œä¸æ˜¯â€œæœ€å¤§ç‰ˆæœ¬å·ä¼˜å…ˆâ€ã€‚

ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹info  log authoritative history
ä¸‰è€…çš„åŸºæœ¬å«ä¹‰ï¼š
1. logï¼ˆæ“ä½œæ—¥å¿—ï¼‰
æ¯ä¸ª OSD å¯¹å®ƒæ‰€æŒæœ‰ PG çš„å†™æ“ä½œä¼šè®°å½•æˆä¸€æ¡æ—¥å¿—ï¼ˆå¦‚ï¼šå¯¹è±¡å†™å…¥ã€åˆ é™¤ã€æ›´æ–°ç­‰ï¼‰ï¼›

è®°å½•çš„æ˜¯æœ€è¿‘ä¸€æ®µæ—¶é—´å†…çš„å˜æ›´ï¼ˆä¸ºèŠ‚çœå†…å­˜ï¼Œæ—§çš„ log å¯èƒ½å·²è¢«ä¸¢å¼ƒï¼‰ï¼›

ç”¨äºè¿½è¸ªå¯¹è±¡çš„å˜æ›´é¡ºåºï¼Œæ”¯æŒå›æ»š/é‡æ”¾ã€‚

2. infoï¼ˆPG çŠ¶æ€ä¿¡æ¯ï¼‰
æ˜¯ PG çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

last_update: æœ€åä¸€ä¸ªå†™æ“ä½œçš„ç‰ˆæœ¬å·ï¼›

last_complete: æœ€åç¡®è®¤ä¸€è‡´çš„ç‰ˆæœ¬å·ï¼›

log_tail: è¢«æˆªæ–­å‰çš„æ—¥å¿—ç‰ˆæœ¬ï¼ˆæ—¥å¿—ä»å“ªé‡Œå¼€å§‹ï¼‰ï¼›

missing: å½“å‰ç¼ºå¤±çš„å¯¹è±¡ï¼›

omap_digestã€size_stats ç­‰ã€‚

info æ˜¯ PG çŠ¶æ€çš„â€œå¿«ç…§â€ã€‚

3. authoritative historyï¼ˆæƒå¨å†å²ï¼‰
å½“ PG æ‰€åœ¨ OSD é‡å¯åï¼ŒåŸæœ‰æ—¥å¿—å¯èƒ½ä¸¢å¤±æˆ–ä¸å®Œæ•´ï¼›

ä¸ºé¿å…æ•°æ®ä¸ä¸€è‡´ï¼ŒCeph è®¾è®¡äº† authoritative historyï¼Œå®ƒæ˜¯ä¸€ä¸ªæ›´é•¿æœŸç¨³å®šçš„ç‰ˆæœ¬å†å²è®°å½•æ‘˜è¦ï¼›

è®°å½•çš„æ˜¯ PG çš„å†å² lineageï¼ˆç‰ˆæœ¬æ¼”åŒ–è·¯å¾„ï¼‰ï¼Œç”¨äºåˆ¤æ–­å“ªäº› OSD ä¿æŒäº†å¯ç”¨çš„å†å²ç‰ˆæœ¬ï¼›

ä¸€ç§ç±»ä¼¼â€œä»£é™…ä¿¡æ¯â€çš„æœºåˆ¶ã€‚

ğŸ§  ååŒå·¥ä½œæµç¨‹ï¼ˆä»¥ PG Peering ä¸ºä¾‹ï¼‰ï¼š
â¤ 1. å¯åŠ¨ Peering
PG æ‰€æœ‰å€™é€‰å‰¯æœ¬ï¼ˆup set ä¸­çš„ OSDï¼‰å¼€å§‹ä¸ŠæŠ¥ info + log + authoritative historyã€‚

â¤ 2. Primaryï¼ˆä¸» OSDï¼‰æ”¶é›†æ•°æ®
æ”¶é›†æ¯ä¸ª OSD æäº¤çš„ï¼š

info.last_updateï¼šå“ªä¸ªå‰¯æœ¬æ•°æ®æœ€â€œæ–°â€ï¼›

log_tailï¼šæ—¥å¿—ä»å“ªé‡Œå¼€å§‹ï¼›

missing setï¼šç¼ºäº†å“ªäº›å¯¹è±¡ï¼›

authoritative historyï¼šæ˜¯å¦èƒ½è¦†ç›–æˆ–åŒ¹é…å…¶ä»– OSD çš„ç‰ˆæœ¬æ¼”åŒ–ã€‚

â¤ 3. åˆ¤æ–­è°æ˜¯â€œå¯ä¿¡å‰¯æœ¬â€
Primary ä¼šæ¯”å¯¹ï¼š

è°çš„ log æœ€å®Œæ•´ï¼›

å“ªäº› OSD çš„ log èŒƒå›´ç›¸äº’é‡å ï¼›

æ˜¯å¦æœ‰äººä¸¢å¤±å…³é”®å†å²æ®µï¼ˆé€šè¿‡ authoritative history æ£€æŸ¥ï¼‰ï¼›

è°æ‹¥æœ‰ last_complete èŒƒå›´ä¸€è‡´çš„å¯¹è±¡ã€‚

â¤ 4. é€‰å‡º acting setï¼Œå¹¶æ„å»º recovery plan
Primary ä¼šé€‰å‡º ä¸€ç»„ log è¿è´¯ã€info å®Œæ•´ã€authoritative history ä¸ç¼ºå¤± çš„å‰¯æœ¬ï¼›

è¿™ç»„å‰¯æœ¬è¢«è®¤ä¸ºæ˜¯â€œå¯ä¿¡å‰¯æœ¬â€ï¼›

ç„¶åæ ¹æ®è¿™äº›å‰¯æœ¬åŒæ­¥å…¶å®ƒè½åçš„ OSDã€‚

ğŸ“Œ ä¸¾ä¸ªä¾‹å­ï¼š
å‡è®¾ PG 100 çš„ up set ä¸º [osd.1, osd.2, osd.3]ï¼š

OSD	log_tail	last_update	authoritative history
osd.1	v.80	v.100	ä» v.0 â†’ v.100
osd.2	v.90	v.100	ä» v.10 â†’ v.100
osd.3	v.95	v.98	ä¸¢å¤± v.80-v.94

osd.3 ä¸¢äº†æ—©æœŸå†å²ï¼Œä¸èƒ½è¢«ä¿¡ä»»ï¼›

osd.1 å’Œ osd.2 è™½ç„¶ log èµ·ç‚¹ä¸åŒï¼Œä½† authoritative history éƒ½åŒ…å«å®Œæ•´é“¾è·¯ï¼›
â†’ æ‰€ä»¥ osd.1 å’Œ osd.2 ä¼šè¿›å…¥ acting setï¼Œosd.3 è¢«æ ‡è®°ä¸ºéœ€è¦æ¢å¤ã€‚

authoritative history:
authoritative history åŒ…å«å“ªäº›ä¿¡æ¯ï¼Ÿ
å®ƒæ˜¯ PG çš„ç‰ˆæœ¬ lineage è®°å½•ï¼Œæ ¸å¿ƒæ•°æ®åŒ…æ‹¬ï¼š

å­—æ®µ	å«ä¹‰
epoch	PG æ‰€åœ¨ OSD æŠ¥å‘Šçš„æŸä¸ªçŠ¶æ€å¿«ç…§ç‰ˆæœ¬
past_intervals	è¿‡å»ä¸€æ®µæ—¶é—´å†…ï¼ŒPG æ‰€å¤„çš„ acting set æƒ…å†µï¼ˆæœ‰å“ªäº› OSDã€epoch èŒƒå›´ï¼‰
interval boundaries	æ¯æ¬¡ acting set å˜åŠ¨æ—¶çš„åˆ†æ®µä½ç½®
purged_snap_ids	è¢«åˆ é™¤çš„å¿«ç…§ IDï¼ˆç”¨äºå¿«ç…§ä¸€è‡´æ€§åˆ¤æ–­ï¼‰
history.same_interval_since	ä»å“ªä¸ª epoch å¼€å§‹ acting set æ²¡å˜
history.last_epoch_started	æœ€è¿‘ä¸€æ¬¡ PG æ´»åŠ¨çš„ epoch

è¿™ä¸ªä¿¡æ¯å¯ç”¨æ¥åˆ¤æ–­ï¼šâ€œè¿™ä¸ª OSD æ˜¯ä¸æ˜¯åœ¨å¤šä¸ª epoch ä¸­éƒ½ä¸€ç›´åœ¨çº¿å¹¶å‚ä¸æ•°æ®å†™å…¥â€ã€‚

ğŸ“ˆ å®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ
æ¥çœ‹ä¸‹ åœ¨ peering è¿‡ç¨‹ä¸­çš„ä½œç”¨ï¼š

OSD å¯åŠ¨/peering æ—¶æ±‡æŠ¥çŠ¶æ€

æ¯ä¸ªå‚ä¸ peering çš„ OSD ä¼šä¸Šä¼ è‡ªå·±çš„ infoã€log å’Œ authoritative historyã€‚

Primary OSD æ”¶é›†æ‰€æœ‰å‰¯æœ¬çš„ history

å®ƒä¼šå°†ä¸åŒ OSD çš„ past_intervalsï¼ˆå†å² acting setï¼‰è¿›è¡Œæ¯”è¾ƒï¼›

æŸ¥çœ‹æ˜¯å¦æœ‰â€œå…¬å…±çš„å†å²æ®µâ€ï¼Œå³å¤šä¸ª OSD åœ¨æŸæ®µæ—¶é—´éƒ½å±äºåŒä¸€ä¸ª acting setï¼›

å¦‚æœæœ‰å…¬å…± history + è‡³å°‘ä¸€ä¸ª OSD çš„ log æ˜¯ä»é‚£æ®µå¼€å§‹çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª OSD å¯ä»¥è¢«ä¿¡ä»»ã€‚

å¼¥è¡¥ log ä¸¢å¤±çš„ gap

å¦‚æœæŸä¸ª OSD çš„ log ä¸¢äº†ï¼Œä½†å®ƒæœ‰å®Œæ•´çš„ authoritative historyï¼›

å¹¶ä¸”æœ‰å…¶ä»–å‰¯æœ¬çš„ log èƒ½è¦†ç›–å®ƒç¼ºå¤±çš„æ—¶é—´æ®µï¼›

å°±å¯ä»¥è®¤ä¸ºè¿™ä¸ª OSD åœ¨é‚£ä¸ªæ—¶é—´æ®µæ˜¯â€œåœ¨åœºçš„â€ï¼Œå…¶æ•°æ®å¯ä»¥è¢«è®¤ä¸ºæ˜¯æ¥è¿‘å®Œæ•´çš„ã€‚

ç”¨äºé‡å»º PG ä¸€è‡´æ€§çŠ¶æ€

Primary ä¼šæ ¹æ®è¿™äº› history æ¥ç¡®å®šå“ªäº›å‰¯æœ¬æ˜¯å¯ä¿¡çš„ï¼›

ç„¶ååŸºäºè¿™äº›å¯ä¿¡å‰¯æœ¬ç”Ÿæˆæ–°çš„ acting setï¼Œå‡†å¤‡ recoveryã€‚

ğŸ§  ä¸¾ä¸ªä¾‹å­å¸®åŠ©ç†è§£ï¼š
å‡è®¾ PG 20 åŸ acting set æ˜¯ [osd.1, osd.2, osd.3]ï¼Œå…¶ä¸­ï¼š

osd.1 é‡å¯äº†ï¼Œlog ä¸¢äº†ï¼›

ä½†å®ƒæäº¤äº† authoritative historyï¼Œè¯´æ˜ï¼š

â€œæˆ‘ä» epoch 100 åˆ° 150 ä¸€ç›´åœ¨ acting set é‡Œï¼Œå’Œ osd.2ã€osd.3 æ˜¯ä¸€èµ·çš„â€ã€‚

è€Œ osd.2 çš„ log æ°å¥½ä» epoch 100 å¼€å§‹å®Œæ•´ï¼Œä¸”å’Œ osd.1 çš„ history åŒ¹é…ã€‚

é‚£ä¹ˆ Primary OSD å°±å¯ä»¥ä¿¡ä»» osd.1 æ˜¯æ•°æ®å®Œæ•´çš„ï¼Œå¯ä»¥ä½œä¸º recovery æ¥æºã€‚


>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>çŠ¶æ€è½¬ç§»ã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Šã€Š
pg åˆ›å»º
1. crush è®¡ç®—éœ€è¦å“ªäº›osd å é”å®šosd map é˜²æ­¢osd æ›´æ–°
2. é€šè¿‡primary osd åˆ›å»ºpg
3. primary åˆ›å»ºå®Œæˆåï¼Œ éšåé€šè¿‡ peering replica osd è‡ªåŠ¨åˆ›å»ºpg

åˆ›å»ºè¿‡ç¨‹ä¸­ éœ€è¦æ£€æŸ¥ä¸€ä¸‹å†…å®¹ï¼š
epoch ä¿è¯osd mapç‰ˆæœ¬ä¸€è‡´
primary é‡åˆ°ç½‘ç»œæ³¢åŠ¨ï¼Œpeimary ä¼šå‘ç”Ÿæ”¹å˜ ä¸ä¸€è‡´ä¼šå¯¼è‡´åœ¨å¤šä¸ªosd åˆ›å»ºpg
acting set ä¸ up set æ˜¯å¦ä¸€è‡´

ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹peering>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
statechart çŠ¶æ€æœº
æœ‰å­çŠ¶æ€æƒ…å†µä¸‹çš„çŠ¶æ€å®šä¹‰
struct Start;
struct Started : boost::statechart::state< Started, RecoveryMachine, Start >, NamedState {
};
çŠ¶æ€Startedä¹Ÿæ˜¯çŠ¶æ€æœºRecoveryMachineçš„ä¸€ä¸ªçŠ¶æ€ï¼Œæ¨¡æ¿å‚æ•°ä¸­å¤šäº†ä¸€ä¸ªå‚æ•°Startï¼Œå®ƒæ˜¯çŠ¶æ€Startedçš„é»˜è®¤åˆå§‹å­çŠ¶æ€ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

struct Start : boost::statechart::state< Start, Started >, NamedState {
};
è¿™é‡Œå®šä¹‰çš„Startæ˜¯çŠ¶æ€Startedçš„å­çŠ¶æ€ã€‚ç¬¬ä¸€ä¸ªæ¨¡æ¿å‚æ•°æ˜¯è‡ªå·±çš„åå­—ï¼Œç¬¬äºŒä¸ªæ¨¡æ¿å‚æ•°æ˜¯è¯¥å­çŠ¶æ€æ‰€å±çˆ¶çŠ¶æ€çš„åå­—ã€‚
ç»¼ä¸Šæ‰€è¿°ï¼Œä¸€ä¸ªçŠ¶æ€ï¼Œè¦ä¹ˆå±äºä¸€ä¸ªçŠ¶æ€æœºï¼Œè¦ä¹ˆå±äºä¸€ä¸ªçŠ¶æ€ï¼Œæˆä¸ºè¯¥çŠ¶æ€çš„å­çŠ¶æ€ã€‚å…¶å®šä¹‰çš„æ¨¡æ¿å‚æ•°æ˜¯è‡ªå·±ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ‹¥æœ‰è€…ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å®ƒçš„èµ·å§‹å­çŠ¶æ€ã€‚
=====================================
peering è¿‡ç¨‹ä»‹ç»ï¼š
https://ivanzz1001.github.io/records/post/ceph/2019/02/01/ceph-src-code-part10_2
 æ€»ç»“
æƒ…å†µ	å«ä¹‰	å¤„ç†æ–¹å¼
æœ‰é‡å 	å¯ä»¥å¯¹æ¯”æ—¥å¿—ï¼Œç¡®å®š missing æ•°æ®	ä½¿ç”¨ recovery
æ— é‡å 	æ— æ³•åˆ¤æ–­å·®å¼‚æ¥æº	ä½¿ç”¨ backfill
æ—¥å¿—å¤šäº†ï¼ˆdivergentï¼‰	æœ¬åœ°æœ‰æœªç¡®è®¤çš„å†™å…¥	åˆ é™¤å¤šä½™æ—¥å¿—
æ—¥å¿—å°‘äº†	æœ¬åœ°ä¸¢å¤±ä¸€éƒ¨åˆ†å†™å…¥è®°å½•	æ·»åŠ æƒå¨æ—¥å¿—è¡¥å…¨ï¼Œæ ‡è®° missing

>>>>>>>>>>>>>>>>>>>>>>>>>ä»€ä¹ˆæ—¶å€™peering
å½“ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼ŒOSDé‡æ–°å¯åŠ¨å¯¼è‡´PGé‡æ–°åŠ è½½ï¼Œæˆ–è€…PGæ–°åˆ›å»ºæ—¶ï¼ŒPGä¼šå‘èµ·ä¸€æ¬¡Peeringçš„è¿‡ç¨‹ï¼›
å½“æœ‰OSDå¤±æ•ˆï¼ŒOSDçš„å¢åŠ æˆ–è€…åˆ é™¤ç­‰å¯¼è‡´PGçš„acting setå‘ç”Ÿäº†å˜åŒ–ï¼Œè¯¥PGå°±ä¼šé‡æ–°å‘èµ·ä¸€æ¬¡Peeringè¿‡ç¨‹ï¼›
peering æµç¨‹ï¼š
æ­¥éª¤1 GetInfo: PGçš„ä¸»OSDé€šè¿‡å‘é€æ¶ˆæ¯è·å–æ‰€æœ‰ä»OSDçš„pg_infoä¿¡æ¯ï¼›
æ­¥éª¤2 GetLog: æ ¹æ®å„ä¸ªå‰¯æœ¬è·å–çš„pg_infoä¿¡æ¯çš„æ¯”è¾ƒï¼Œé€‰æ‹©ä¸€ä¸ªæ‹¥æœ‰æƒå¨æ—¥å¿—çš„OSD(auth_log_shard)ã€‚å¦‚æœä¸»OSDä¸æ˜¯æ‹¥æœ‰æƒå¨æ—¥å¿—çš„OSDï¼Œå°±ä»è¯¥OSDä¸Šæ‹‰å–æƒå¨æ—¥å¿—ã€‚ä¸»OSDå®Œæˆæ‹‰å–æƒå¨æ—¥å¿—åä¹Ÿå°±æ‹¥æœ‰äº†æƒå¨æ—¥å¿—ã€‚
æ­¥éª¤3 GetMissing: ä¸»OSDæ‹‰å–å…¶ä»–ä»OSDçš„PGæ—¥å¿—ï¼ˆæˆ–è€…éƒ¨åˆ†è·å–ï¼Œæˆ–è€…å…¨éƒ¨è·å–FULL_LOG)ã€‚é€šè¿‡ä¸æœ¬åœ°æƒå¨æ—¥å¿—çš„å¯¹æ¯”ï¼Œæ¥è®¡ç®—è¯¥OSDä¸Šç¼ºå¤±çš„objectä¿¡æ¯ï¼Œä½œä¸ºåç»­Recoveryæ“ä½œè¿‡ç¨‹çš„ä¾æ®ã€‚

æœ€åé€šè¿‡Activeæ“ä½œæ¿€æ´»ä¸»OSDï¼Œå¹¶å‘é€notifyé€šçŸ¥æ¶ˆæ¯ï¼Œæ¿€æ´»ç›¸åº”çš„ä»OSD
>>>>>>>>>>>>>>>>>>>>>>recovery backfill>>>>>>>>>>>>>>>>>>>>>>>>>>
åœ¨ Ceph ä¸­ï¼ŒPG çš„ Recovery å’Œ Backfill éƒ½æ˜¯ç”¨äº æ•°æ®ä¿®å¤å’ŒåŒæ­¥ çš„æœºåˆ¶ï¼Œä½†å®ƒä»¬é€‚ç”¨äºä¸åŒçš„åœºæ™¯ã€æ–¹å¼å’Œæ•ˆç‡ã€‚æˆ‘ä»¬æ¥è¯¦ç»†æ¯”è¾ƒä¸¤è€…ï¼š

âœ… ä¸€å¥è¯åŒºåˆ«ï¼š
ç±»å‹	ç®€è¦è¯´æ˜
Recovery	ä¿®å¤åŸæœ¬å±äº acting set çš„ OSD ä¸Šç¼ºå¤±çš„æ•°æ®ã€‚
Backfill	ä¿®å¤æ–°åŠ å…¥ acting set çš„ OSDï¼Œè®©å®ƒæ‹¥æœ‰å®Œæ•´ PG å‰¯æœ¬ã€‚


